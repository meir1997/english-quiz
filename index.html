<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>אוצר מילים באנגלית</title>
  <style>
    body { direction: rtl; font-family: Arial, sans-serif; background: #fafafa; }
    #main-content { max-width: 700px; margin: 40px auto; text-align: center; }
    #menu-bar { margin: 20px 0; }
    #menu-bar button { margin: 0 5px; padding: 8px 18px; font-size: 1.1em; border-radius: 8px; border: none; background: #eee; cursor: pointer; }
    #menu-bar button:hover { background: #d0eaff; }
    .option { display: block; margin: 10px auto; padding: 10px 30px; font-size: 1.1em; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; }
    .option:hover { background: #e0f7fa; }
    #feedback { margin: 15px; font-size: 1.2em; }
    #score { font-weight: bold; }
  </style>
</head>
<body>
  <div id="main-content">טוען...</div>
  <button id="home-btn" style="position:fixed;top:20px;left:20px;z-index:1000;padding:10px 18px;font-size:1.1em;border-radius:8px;border:none;background:#e0f7fa;cursor:pointer;">דף הבית</button>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVRxq8xDuZbF7Jxyz74qMQzGj09zIjhhU",
      authDomain: "vocab-app-meir.firebaseapp.com",
      projectId: "vocab-app-meir",
      storageBucket: "vocab-app-meir.appspot.com",
      messagingSenderId: "71704465708",
      appId: "1:71704465708:web:e5aed9325adf4979b89c89",
      measurementId: "G-ZVCT2T78ZT"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // פונקציות גיבוי ושחזור
    window.saveProgressToCloud = async function() {
      const userId = prompt("הכנס מזהה משתמש (למשל אימייל):");
      if (!userId) return;
      const data = {
        vocabScore: localStorage.getItem('vocabScore'),
        learnedWords: localStorage.getItem('learnedWords'),
        appearedWords: localStorage.getItem('appearedWords')
      };
      await setDoc(doc(db, "users", userId), data);
      alert("ההתקדמות נשמרה בענן!");
    }

    window.loadProgressFromCloud = async function() {
      const userId = prompt("הכנס מזהה משתמש (למשל אימייל):");
      if (!userId) return;
      const docSnap = await getDoc(doc(db, "users", userId));
      if (docSnap.exists()) {
        const data = docSnap.data();
        localStorage.setItem('vocabScore', data.vocabScore || '0');
        localStorage.setItem('learnedWords', data.learnedWords || '[]');
        localStorage.setItem('appearedWords', data.appearedWords || '[]');
        alert("ההתקדמות שוחזרה מהענן!");
        location.reload();
      } else {
        alert("לא נמצאה התקדמות עבור משתמש זה.");
      }
    }
  </script>
  <script>
fetch('words_quiz_he.json')
  .then(response => response.json())
  .then(quizWords => {
    let words = [];
    let score = parseInt(localStorage.getItem('vocabScore') || '0', 10);
    let current = 0;
    let learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
    let appearedWords = JSON.parse(localStorage.getItem('appearedWords') || '[]');

    function goHome() {
      let html = `
        <h1>אוצר מילים באנגלית</h1>
        <div id="score">ניקוד: ${score}</div>
        <div id="menu-bar">
          <button id="start-quiz-btn">התחל תרגול</button>
          <button id="unknown-btn">למד מילים שלא ידעתי</button>
          <button id="learned-btn">מילים שלמדתי</button>
          <button id="all-words-btn">רשימת כל המילים</button>
          <button id="backup-btn">גיבוי לענן</button>
          <button id="restore-btn">שחזור מהענן</button>
        </div>
      `;
      document.getElementById('main-content').innerHTML = html;
      document.getElementById('start-quiz-btn').onclick = startQuiz;
      document.getElementById('unknown-btn').onclick = startUnknownQuiz;
      document.getElementById('learned-btn').onclick = showLearnedWords;
      document.getElementById('all-words-btn').onclick = showAllWords;
      document.getElementById('backup-btn').onclick = window.saveProgressToCloud;
      document.getElementById('restore-btn').onclick = window.loadProgressFromCloud;
    }

    function showAllWords(filter = 'all') {
      learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
      appearedWords = JSON.parse(localStorage.getItem('appearedWords') || '[]');
      let filtered = quizWords;
      if (filter === 'known') filtered = quizWords.filter(w => learnedWords.includes(w.word));
      if (filter === 'unknown') filtered = quizWords.filter(w => appearedWords.includes(w.word) && !learnedWords.includes(w.word));
      if (filter === 'not-seen') filtered = quizWords.filter(w => !appearedWords.includes(w.word));
      let html = `<h2>רשימת כל המילים</h2>
        <div>
          <button id="filter-all">הכל</button>
          <button id="filter-known">שלמדתי</button>
          <button id="filter-unknown">שלא ידעתי</button>
          <button id="filter-not-seen">שטרם הופיעו</button>
        </div>
        <ul style="list-style:none;padding:0;">
      `;
      html += filtered.map(w => {
        let status = learnedWords.includes(w.word) ? '✔️' : (appearedWords.includes(w.word) ? '❌' : '⏳');
        return `<li>${w.word} ${status}</li>`;
      }).join('') + '</ul>';
      html += `<button id="back-btn">חזור</button> <button id="scroll-top-btn">חזור למעלה</button>`;
      document.getElementById('main-content').innerHTML = html;
      document.getElementById('back-btn').onclick = goHome;
      document.getElementById('filter-all').onclick = () => showAllWords('all');
      document.getElementById('filter-known').onclick = () => showAllWords('known');
      document.getElementById('filter-unknown').onclick = () => showAllWords('unknown');
      document.getElementById('filter-not-seen').onclick = () => showAllWords('not-seen');
      document.getElementById('scroll-top-btn').onclick = () => window.scrollTo({top:0,behavior:'smooth'});
    }

    function startQuiz() {
      words = shuffle([...quizWords]);
      score = parseInt(localStorage.getItem('vocabScore') || '0', 10);
      current = 0;
      learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
      appearedWords = JSON.parse(localStorage.getItem('appearedWords') || '[]');
      showQuestion();
    }

    function startUnknownQuiz() {
      learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '0');
      appearedWords = JSON.parse(localStorage.getItem('appearedWords') || '[]');
      const unknown = quizWords.filter(w => appearedWords.includes(w.word) && !learnedWords.includes(w.word));
      if (unknown.length === 0) {
        document.getElementById('main-content').innerHTML = '<h2>אין מילים שלא ידעת!</h2><button id="back-btn">חזור</button>';
        document.getElementById('back-btn').onclick = goHome;
        return;
      }
      words = shuffle([...unknown]);
      score = parseInt(localStorage.getItem('vocabScore') || '0', 10);
      current = 0;
      showQuestion();
    }

    function showLearnedWords() {
      learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
      let filteredLearned = quizWords.filter(w => learnedWords.includes(w.word));
      let html = `<h2>מילים שלמדת</h2>`;
      if (filteredLearned.length === 0) {
        html += '<div>לא נמצאו מילים שלמדת</div>';
      } else {
        html += '<ul style="list-style:none;padding:0;">' +
          filteredLearned.map(w => `<li>${w.word} ✔️</li>`).join('') + '</ul>';
      }
      html += `<button id="back-btn">חזור</button>`;
      document.getElementById('main-content').innerHTML = html;
      document.getElementById('back-btn').onclick = goHome;
    }

    function showQuestion() {
      if (current >= words.length) {
        document.getElementById('main-content').innerHTML = `<h2>סיימת את כל המילים!</h2><div id="score">ניקוד: ${score}</div><button id="back-btn">חזור</button>`;
        document.getElementById('back-btn').onclick = goHome;
        return;
      }
      const w = words[current];
      // שמור הופעה של מילה ב-localStorage
      let appearedWords = JSON.parse(localStorage.getItem('appearedWords') || '[]');
      if (!appearedWords.includes(w.word)) {
        appearedWords.push(w.word);
        localStorage.setItem('appearedWords', JSON.stringify(appearedWords));
      }
      let html = `<h2 id="word">${w.word}</h2>
        <div id="options"></div>
        <div id="feedback"></div>
        <div id="score">ניקוד: ${score}</div>
      `;
      document.getElementById('main-content').innerHTML = html;
      const optionsDiv = document.getElementById('options');
      w.options.forEach(option => {
        const btn = document.createElement('button');
        btn.textContent = option;
        btn.className = 'option';
        btn.onclick = () => {
          if (option === w.correct) {
            document.getElementById('feedback').textContent = 'נכון!';
            score++;
            localStorage.setItem('vocabScore', score);
            // הוספת המילה ל-learnedWords אם לא קיימת
            let learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
            if (!learnedWords.includes(w.word)) {
              learnedWords.push(w.word);
              localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
            }
            // הסר את המילה מ-appearedWords אם קיימת
            let appearedWords2 = JSON.parse(localStorage.getItem('appearedWords') || '[]');
            if (appearedWords2.includes(w.word)) {
              appearedWords2 = appearedWords2.filter(word => word !== w.word);
              localStorage.setItem('appearedWords', JSON.stringify(appearedWords2));
            }
          } else {
            document.getElementById('feedback').textContent = 'טעות. התשובה הנכונה: ' + w.correct;
          }
          document.getElementById('score').textContent = 'ניקוד: ' + score;
          current++;
          if (current < words.length) {
            setTimeout(() => {
              document.getElementById('feedback').textContent = '';
              showQuestion();
            }, 1000);
          } else {
            setTimeout(() => showQuestion(), 1000);
          }
        };
        optionsDiv.appendChild(btn);
      });
      // הוסף כפתור "לא יודע"
      const dontKnowBtn = document.createElement('button');
      dontKnowBtn.textContent = 'לא יודע';
      dontKnowBtn.className = 'option';
      dontKnowBtn.style.backgroundColor = '#ffe0e0';
      dontKnowBtn.onclick = () => {
        let appearedWords3 = JSON.parse(localStorage.getItem('appearedWords') || '[]');
        if (!appearedWords3.includes(w.word)) {
          appearedWords3.push(w.word);
          localStorage.setItem('appearedWords', JSON.stringify(appearedWords3));
        }
        document.getElementById('feedback').textContent = "הוספת ל'לא ידעתי'";
        current++;
        if (current < words.length) {
          setTimeout(() => {
            document.getElementById('feedback').textContent = '';
            showQuestion();
          }, 700);
        } else {
          setTimeout(() => showQuestion(), 700);
        }
      };
      optionsDiv.appendChild(dontKnowBtn);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    document.getElementById('home-btn').onclick = () => location.reload();

    // הפעל את דף הבית ברגע שהכל נטען
    goHome();
  })
  .catch(error => {
    document.getElementById('main-content').textContent = 'שגיאה בטעינת החידון';
    console.error('Error loading JSON:', error);
  });
  </script>
</body>
</html>
